#!/usr/bin/env php
<?php
    
    require __DIR__.'/vendor/autoload.php';

    use JonnyW\PhantomJs\Client;

    $catalog_id = 62765;

    $urls = [
        "16217896",
        "951130",
        "152900",
        "7685902",
        "7274947",
        "14259474",
        "12608496",
        "206930",
        "7695403",
        "2310287",
        "206935",
        "14259490",
        "16257364",
        "240929",
        "16581655",
        "16340788",
        "950013",
        "14989774",
        "237661",
        "14000285",
        "4960186",
        "16340722",
        "1011902",
        "152898",
        "153093",
        "239137",
        "7162406",
        "16640166",
        "16222429",
        "14848749",
        "1581575",
        "987062",
        "4650077",
        "264696",
        "12738640",
        "928731",
        "925439"
    ];


$proxy = [
    '81.22.46.41:1085',
    '81.22.46.32:1085',
    '95.181.217.239:1085',
    '5.188.217.160:1085',
    '5.188.219.47:1085',
    '5.188.217.52:1085',
    '5.188.217.187:1085',
    '95.181.217.209:1085',
    '5.188.219.144:1085',
    '5.188.219.219:1085',
    '5.188.219.66:1085',
    '95.181.217.6:1085',
    '5.188.217.222:1085',
    '5.188.219.128:1085',
    '5.188.217.28:1085',
    '5.188.217.27:1085',
    '81.22.46.234:1085',
    '5.188.217.168:1085',
    '5.188.217.73:1085',
    '5.188.219.145:1085',
    '95.181.217.46:1085',
    '5.188.219.122:1085',
    '81.22.46.67:1085',
    '5.188.219.172:1085',
    '5.188.217.199:1085',
    '95.181.217.252:1085',
    '5.188.219.207:1085',
    '81.22.46.108:1085',
    '95.181.217.50:1085',
    '5.188.219.156:1085',
    '81.22.46.82:1085',
    '5.188.217.29:1085',
    '95.181.217.176:1085',
    '81.22.46.160:1085',
    '81.22.46.185:1085',
    '5.188.219.104:1085',
    '5.188.217.216:1085',
    '5.188.219.110:1085',
    '95.181.217.238:1085',
    '5.188.217.170:1085',
    '95.181.217.15:1085',
    '81.22.46.237:1085',
    '95.181.217.223:1085',
    '5.188.217.186:1085',
    '95.181.217.177:1085',
    '5.188.217.205:1085',
    '5.188.217.106:1085',
    '81.22.46.88:1085',
    '81.22.46.240:1085',
    '5.188.217.123:1085',
    '5.188.217.213:1085',
    '5.188.217.243:1085',
    '5.188.219.98:1085',
    '5.188.217.152:1085',
    '5.188.219.74:1085',
    '5.188.219.27:1085',
    '5.188.219.86:1085',
    '95.181.217.95:1085',
    '5.188.219.146:1085',
    '5.188.217.104:1085',
    '95.181.217.112:1085',
    '5.188.219.49:1085',
    '5.188.217.70:1085',
    '95.181.217.230:1085',
    '95.181.217.93:1085',
    '5.188.217.173:1085',
    '5.188.217.128:1085',
    '81.22.46.222:1085',
    '5.188.219.61:1085',
    '81.22.46.229:1085',
    '5.188.217.182:1085',
    '5.188.219.79:1085',
    '5.188.217.11:1085',
    '5.188.217.231:1085',
    '81.22.46.68:1085',
    '81.22.46.231:1085',
    '5.188.219.34:1085',
    '5.188.217.17:1085',
    '81.22.46.125:1085',
    '5.188.219.148:1085',
    '5.188.219.32:1085',
    '95.181.217.34:1085',
    '5.188.217.78:1085',
    '81.22.46.151:1085',
    '81.22.46.247:1085',
    '5.188.217.192:1085',
    '81.22.46.140:1085',
    '5.188.219.81:1085',
    '5.188.219.100:1085',
    '5.188.219.225:1085',
    '95.181.217.228:1085',
    '81.22.46.105:1085',
    '95.181.217.125:1085',
    '5.188.217.242:1085',
    '81.22.46.147:1085',
    '81.22.46.202:1085',
    '81.22.46.102:1085',
    '81.22.46.74:1085',
    '81.22.46.112:1085',
    '95.181.217.14:1085',
    '95.181.217.142:1085',
    '5.188.217.30:1085',
    '81.22.46.165:1085',
    '5.188.219.43:1085',
    '5.188.217.191:1085',
    '5.188.217.41:1085',
    '81.22.46.216:1085',
    '81.22.46.173:1085',
    '95.181.217.166:1085',
    '81.22.46.81:1085',
    '5.188.217.60:1085',
    '81.22.46.206:1085',
    '81.22.46.65:1085',
    '81.22.46.62:1085',
    '81.22.46.42:1085',
    '5.188.219.154:1085',
    '81.22.46.196:1085',
    '5.188.217.37:1085',
    '5.188.219.126:1085',
    '5.188.219.224:1085',
    '5.188.219.195:1085',
    '81.22.46.56:1085',
    '81.22.46.221:1085',
    '5.188.219.194:1085',
    '95.181.217.178:1085',
    '5.188.217.214:1085',
    '95.181.217.59:1085',
    '5.188.217.76:1085',
    '5.188.219.160:1085',
    '81.22.46.63:1085',
    '5.188.219.226:1085',
    '5.188.219.150:1085',
    '5.188.219.185:1085',
    '81.22.46.58:1085',
    '81.22.46.12:1085',
    '5.188.217.179:1085',
    '81.22.46.178:1085',
    '5.188.219.221:1085',
    '5.188.219.168:1085',
    '95.181.217.82:1085',
    '81.22.46.94:1085',
    '5.188.217.139:1085',
    '81.22.46.186:1085',
    '95.181.217.77:1085',
    '5.188.219.28:1085',
    '5.188.219.130:1085',
    '5.188.217.241:1085',
    '5.188.219.22:1085'
];

    $handle = fopen("./urls_".$catalog_id.".txt","a");
    foreach($urls as $key=>$url){

        $active = true;

        $i = 1;
        while ($active === true){
            shuffle($proxy);
            $client = Client::getInstance();
            $client->getEngine()->addOption('--ignore-ssl-errors=true');
//            $client->getEngine()->addOption("--proxy=".$proxy[0]);
//            $client->getEngine()->addOption("--proxy-type=socks5");
            $request  = $client->getMessageFactory()->createRequest();
            $response = $client->getMessageFactory()->createResponse();
            $request->setTimeout(10000);
            $request->setMethod('GET');

            if(isset($url_next_page)){
                $request->setUrl($url_next_page);
            } else {
                $request->setUrl('https://market.yandex.ru/catalog/'.$catalog_id.'/list?glfilter=7893318%3A'.$url.'&local-offers-first=0&viewtype=list&onstock=0');
            }

            $client->send($request, $response);

            if($response->getStatus() === 200) {
                unset($url_next_page);
                preg_match_all('/.+n-snippet-card2__title.+href=\\"(\/product.+)\\".+title=\\"(.+)\\"/Uis', $response->getContent(), $output_array);
                print_r($output_array[1]);

                foreach($output_array[1] as $oa){
                    preg_match("/(\/product.*\/[0-9]+)/", $oa, $l);
                    if(isset($l[0]) && !empty($l[0])){
                        fwrite($handle,$l[0]."\r\n");
                    }
                }

                preg_match_all('/<\/a><a href=\".+page=([0-9]+)\"/Uis', $response->getContent(), $output_array_next);
                if(isset($output_array_next[1]) && !empty($output_array_next[1]) && max($output_array_next[1])>=$i+1){
                    $i++;
                    $url_next_page = 'https://market.yandex.ru/catalog/'.$catalog_id.'/list?glfilter=7893318%3A'.$url.'&local-offers-first=0&viewtype=list&onstock=0'.'&page='.$i;
                    print_r($url_next_page);
                    print_r("Page - ".$i);
                } else {
                    $active = false;
                    print_r("Brand $key is done ($url). Proxy $proxy[0]"."\r\n");
                }
            } elseif($response->getStatus() === 408) {
                print_r($proxy[0]);
                print_r("Request timeout");
            } /*else {
                print_r("Something went wrong . Status - ".$response->getStatus());
                print_r("Redirect URL - ".$response->getRedirectUrl());
            }*/
        }
    }
    fclose($handle);
